<!DOCTYPE html>
<html lang="en">
	<head>
		<title>CRSocket, eventsource</title>
		<meta http-equiv="Content-Type" content="text/html;charset=utf-8">
		<link href="../css/styles.css" rel="stylesheet" type="text/css">
	</head>
	<body>
		<h1>eventsource</h1>
		<p>This resource generates a text/event-stream consisting of server-sent events sent from other clients or the requesting client</p>
		<p>The stream will allways be opened, but will be aborted if appropriate credentials have not been provided</p>
		<p>This resource must not be subjected to any kind of buffering mechanism</p>
		<h2>Internal constants</h2>
		<dl>
			<dt id="name">crConfig</dt>
			<dd>Configuration parameters and methods, including the current appId</dd>
		</dl>
		
		<h2>Request parameters</h2>
		<dl>
			<dt id="clientid">clientid</dt>
			<dd>Identifies the recipient client</dd>
			
			<dt id="clientRole">clientRole</dt>
			<dd>The role of the recipient client ("controller" or "responder")</dd>
			
			<dt id="accessToken">accessToken</dt>
			<dd>An URLEncoded string containing the accessToken used to identify the current user and determine access rights</dd>
		</dl>
		
		
		<h2>Response</h2>
		<p>A text/event-stream stream</p>
		
		<h2 id="protocol">Event handling protocol</h2>
		<p>Incoming events not listed below will be ignored</p>
		<p>For incoming events, the appId, clientRole, clientId and accessToken of the sender must be available for internal use</p>
		
		<h3 id="eventInReq">Incoming events from the connected client</h3>
		<p>These events must contain the pid of the senders current eventsource instance</p>
		<p>Events from senders with a clientId, clientRole or eventSourcePid not matching the current instance will be ignored.</p>
		<dl>
			<dt id="alive">alive</dt>
			<dd>A messageEvent signalling that the recipient client is alive</dd>
			<dd>
				The eventSource should be closed when it has not received such events for <a href="../php/CRConfig.html#maxPrevAliveDtSecs">maxPrevAliveDtSecs</a> millisecs.
			</dd>
			
			<dt id="close">close</dt>
			<dd>
				A messageEvent signalling that the event stream should close immediately. The eventsource should respond with a
				<span class="name">closed</span> event and then terminate. Closing this way is generally faster than just closing the eventStream using the JavaScript API.
			</dd>
		</dl>
		
		<h3 id="eventInOther">Incoming events from other eventsource instances</h3>
		<p>Events from instances with a clientId or clientRole not matching the current instance will be ignored.</p>
		<dl>
			<dt id="release">release</dt>
			<dd>
				A messageEvent signalling that another eventsource instance will take over the stream. The eventsource should respond with a
				<span class="name">aborted</span> event with subType
				<span class="name">releasedByOther</span> and the pid of the process that sent the release event, and then terminate. This event is used to handle situations where a competing client with the same clientId has been activated or that regular termination of an eventsource instance has been delayed so that the replacement instance has started.
			</dd>
		</dl>
		
		<h3 id="eventOutReq">Outgoing events to the requesting client</h3>
		In addition to
		<a href="https://developer.mozilla.org/en-US/docs/Web/API/EventSource/open_event">open</a> and
		<a href="https://developer.mozilla.org/en-US/docs/Web/API/EventSource/error_event">error</a> events generated by the JavaScript
		<a href="https://developer.mozilla.org/en-US/docs/Web/API/EventSource">EventSource</a> object, the following
		<a href="https://developer.mozilla.org/en-US/docs/Web/API/EventSource/message_event">message</a> events are forwarded to the requesting client:
		<dl>
			<dt id="hello">hello</dt>
			<dd>
				A messageEvent signalling that the event stream is active. This event must contain the pid of the current instance and all subsequent events must match this pid.
			</dd>
			
			<dt id="closed">closed</dt>
			<dd>
				A messageEvent confirming that the event stream has been closed. Must contain the current pid.
			</dd>
			
			<dt id="aborted">aborted</dt>
			<dd>A messageEvent signalling that the event stream has been aborted</dd>
			<dd>
				Must contain the current pid, and a (potentially empty) code indicating why the stream was aborted. If the abortion was caused by a
				<span class="name">release</span> event, it must also contain the pid of the releasing eventsource.
			</dd>
			
			<dt id="shutdown">shutdown</dt>
			<dd>
				A messageEvent signalling that the eventsource instance is about to be shut down, typically due to server timeout. This event enables immediate reopening by the client without default delays.
			</dd>
			
			<dt id="crEvent">crEvent</dt>
			<dd>A messageEvent containing a crEvent, forwarded from another crSocket.</dd>
		</dl>
		
		<h3 id="eventInOther">Incoming events from other clients</h3>
		<dl>
			<dt>crEvent</dt>
			<dd>A messageEvent containing a crEvent, received from another client</dd>
			<dd>
				Only events from clients with a matching appId and complimentary client role will be forwarded to the recipient client.
			</dd>
		</dl>
		<p>
			If the <a href="../php/CREvent.html#interceptable">interceptable</a> property is true
			it may be blocked or modified by the <a href="../php/CRConfig.html#acceptAtEventSource">acceptAtEventSource</a> function. This function may also respond with custom crEvents to the other client.
		</p>
		
		<h3 id="eventOutOther">Outgoing events to other clients</h3>
		<dl>
			<dt>crEvent.reject</dt>
			<dd>
				A messageEvent containing a crEvent with
				<a href="../php/CREvent.html#eventType">eventType</a>
				<span class="name">reject</span>
			</dd>
			<dd>
				This event will be returned to the sender if a crEvent with
				<a href="../php/CREvent.html#eventType">eventType</a>
				<span class="name">ping</span> event was not forwarded
			</dd>
			<dd>
				The <a href="../php/CREvent.html#eventSubType">eventSubType</a> property may contain a code indicating why the event was rejected.
			</dd>
		</dl>
	</body>
</html>
